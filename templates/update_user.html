<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update User - ACADEMY MEDICAL CLINIC</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #166088;
            --accent: #4fc3f7;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --text: #444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
            color: var(--text);
            line-height: 1.6;
        }
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem 0;
            position: fixed;
            height: 100%;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .sidebar-header { padding: 0 1.5rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { display: flex; align-items: center; margin-bottom: 1rem; }
        .logo i { font-size: 1.75rem; color: var(--accent); margin-right: 0.75rem; }
        .logo-text { font-size: 1.25rem; font-weight: 600; }
        .sidebar-menu { padding: 1.5rem 0; }
        .menu-item {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 20px; text-align: center; }
        .main-content { flex: 1; margin-left: 250px; padding: 1.5rem; transition: all 0.3s ease; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        .header h1 { font-size: 1.75rem; color: var(--secondary); }
        .user-profile { display: flex; align-items: center; }
        .user-profile img {
            width: 40px; height: 40px; border-radius: 50%; margin-right: 0.75rem; object-fit: cover;
        }
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h2 { font-size: 1.25rem; color: var(--secondary); }
        .card-body { padding: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--secondary); }
        .form-control {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(79,195,247,0.2);
            outline: none;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
        }
        .btn i { margin-right: 0.5rem; }
        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 10px rgba(22,96,136,0.2);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(22,96,136,0.3);
        }
        .btn-block { display: block; width: 100%; }
        @media (max-width: 992px) {
            .sidebar { width: 80px; overflow: hidden; }
            .logo-text, .menu-item span { display: none; }
            .menu-item { justify-content: center; padding: 0.75rem; }
            .menu-item i { margin-right: 0; font-size: 1.25rem; }
            .main-content { margin-left: 80px; }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; gap: 1rem; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar (same as admin dashboard) -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-heartbeat"></i>
                    <span class="logo-text">ACADEMY MEDICAL</span>
                </div>
            </div>
            <div class="sidebar-menu">
                <a href="{{ url_for('admin_dashboard') }}" class="menu-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('create_user') }}" class="menu-item">
                    <i class="fas fa-user-plus"></i>
                    <span>Create User</span>
                </a>
                <a href="{{ url_for('manage_encryption') }}" class="menu-item">
                    <i class="fas fa-lock"></i>
                    <span>Encryption</span>
                </a>
                <a href="{{ url_for('view_system_logs') }}" class="menu-item">
                    <i class="fas fa-clipboard-list"></i>
                    <span>System Logs</span>
                </a>
                <a href="{{ url_for('generate_health_report') }}" class="menu-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Health Reports</span>
                </a>
                <a href="{{ url_for('settings') }}" class="menu-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Update User</h1>
                <div class="user-profile">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=4a6fa5&color=fff" alt="Admin">
                    <div>
                        <div style="font-weight: 500;">Admin</div>
                        <a href="{{ url_for('logout') }}" style="font-size: 0.8rem; color: var(--danger);">Logout</a>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2>User: {{ user.username }} <span style="font-size:0.9rem; color:var(--accent);">({{ user.role|capitalize }})</span></h2>
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-primary" style="font-size:0.9rem;"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="form-group">
                            <label class="form-label" for="password">Password</label>
                            <input type="text" class="form-control" id="password" name="password" required value="{{ user.password }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="role">Role</label>
                            <select class="form-control" id="role" name="role">
                                <option value="student" {% if user.role == 'student' %}selected{% endif %}>Student</option>
                                <option value="parent" {% if user.role == 'parent' %}selected{% endif %}>Parent</option>
                                <option value="staff" {% if user.role == 'staff' %}selected{% endif %}>Staff</option>
                                <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                            </select>
                        </div>
                        <!-- Student Reference ID Dropdown for Parents -->
                        <div class="form-group" id="studentRefGroup" style="display: none;">
                            <label class="form-label" for="student_ref_id">Student Reference ID (for parents)</label>
                            <input type="text" class="form-control" id="studentSearch" placeholder="Search student by name...">
                            <div style="max-height:200px;overflow-y:auto;border:1px solid #eee;border-radius:6px;margin-top:0.5rem;">
                                <select class="form-control" id="student_ref_id" name="student_ref_id" size="6" style="height:auto;">
                                    <option value="">Select Student</option>
                                    {% for student in under16_students %}
                                        <option value="{{ student.user_id }}" data-name="{{ student.first_name }} {{ student.last_name }}" {% if user.student_ref_id == student.user_id %}selected{% endif %}>
                                            {{ student.first_name }} {{ student.last_name }} (Age: {{ student.age }}) - ID: {{ student.user_id }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% for student in under16_students %}
                                    <img src="{{ url_for('static', filename=student.profile_photo.replace('static/', '')) if student.profile_photo else 'https://ui-avatars.com/api/?name=' + student.first_name + '+' + student.last_name + '&background=4a6fa5&color=fff' }}" alt="Profile" style="width:32px;height:32px;border-radius:50%;margin:2px;vertical-align:middle;display:none;" data-userid="{{ student.user_id }}">
                                {% endfor %}
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:2rem;">
                            <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-save"></i> Update User</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
    // Show/hide Student Reference ID dropdown based on role
    const roleSelect = document.getElementById('role');
    const studentRefGroup = document.getElementById('studentRefGroup');
    function toggleStudentRefGroup() {
        if (roleSelect.value === 'parent') {
            studentRefGroup.style.display = 'block';
        } else {
            studentRefGroup.style.display = 'none';
            document.getElementById('student_ref_id').value = '';
        }
    }
    roleSelect.addEventListener('change', toggleStudentRefGroup);
    toggleStudentRefGroup();

    // Real-time search for students
    const studentSearch = document.getElementById('studentSearch');
    const studentSelect = document.getElementById('student_ref_id');
    studentSearch.addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        for (let i = 0; i < studentSelect.options.length; i++) {
            const opt = studentSelect.options[i];
            if (i === 0) continue; // skip placeholder
            const name = opt.getAttribute('data-name').toLowerCase();
            opt.style.display = name.includes(filter) ? '' : 'none';
        }
    });
    // Show profile photo next to selected student
    studentSelect.addEventListener('change', function() {
        const imgs = studentRefGroup.querySelectorAll('img[data-userid]');
        imgs.forEach(img => img.style.display = 'none');
        const selected = studentSelect.value;
        if (selected) {
            const img = studentRefGroup.querySelector('img[data-userid="' + selected + '"]');
            if (img) img.style.display = 'inline-block';
        }
    });
    // Show photo if already selected
    document.addEventListener('DOMContentLoaded', function() {
        studentSelect.dispatchEvent(new Event('change'));
    });
    </script>
</body>
</html>
